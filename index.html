<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TogetherTime</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #1a1a2e;
            color: white;
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .message-box {
            background-color: #2a2a44;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body class="bg-[#1a1a2e] text-white">
    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="p-4 flex justify-between items-center bg-[#2a2a44] rounded-b-xl shadow-lg">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-pink-500">TogetherTime</h1>
            <div id="auth-status" class="flex items-center space-x-2">
                <span id="auth-text" class="text-green-400">Auth Initializing...</span>
                <span id="user-id-display" class="bg-gray-700 rounded-full px-3 py-1 text-sm hidden"></span>
                <a id="invite-link" href="#" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300">Invite</a>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col items-center justify-center p-4">
            <div id="video-container" class="relative w-full h-full bg-black rounded-xl overflow-hidden shadow-2xl flex items-center justify-center">
                <video id="remote-video" class="w-full h-full object-contain" autoplay playsinline></video>
                <div id="loading-message" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-75 rounded-xl text-white text-2xl">
                    Waiting for host to share screen...
                </div>
            </div>
        </main>
        
        <!-- Action Buttons (Host controls) -->
        <footer class="p-4 flex justify-center space-x-4">
            <button id="become-host" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105">Become Host & Share Screen</button>
            <button id="turn-mic-on" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105">Turn Mic On</button>
            <button id="choose-video" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105">Choose Video File</button>
        </footer>
    </div>
    
    <!-- Custom Modal for Alerts -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-[#2a2a44] rounded-lg p-6 shadow-xl w-80">
            <h3 id="modal-title" class="text-lg font-bold mb-2"></h3>
            <p id="modal-message" class="text-gray-300 mb-4"></p>
            <button id="modal-ok-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full">OK</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        const hostDocPath = `/artifacts/${appId}/public/data/host_session/current_host`;

        // --- UI Elements ---
        const authTextEl = document.getElementById('auth-text');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const remoteVideoEl = document.getElementById('remote-video');
        const loadingMessageEl = document.getElementById('loading-message');
        const inviteLinkEl = document.getElementById('invite-link');

        // --- Custom Modal Functions ---
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');

        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        modalOkBtn.onclick = () => {
            modal.classList.add('hidden');
        };

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase() {
            if (!firebaseConfig) {
                showModal("Configuration Error", "Firebase configuration is not available. Please ensure the app is properly configured.");
                console.error("Firebase config not found. Host this app via a platform that provides the config.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Set up authentication listener to get the user ID
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authTextEl.textContent = 'Auth successful!';
                        userIdDisplayEl.textContent = `User ID: ${userId}`;
                        userIdDisplayEl.classList.remove('hidden');
                        
                        // Update the invite link with the current user's ID
                        const inviteUrl = `${window.location.origin}${window.location.pathname}?inviteId=${userId}`;
                        inviteLinkEl.href = inviteUrl;

                        console.log(`User authenticated with UID: ${userId}`);

                        // Start listening for host data after authentication is complete
                        listenForHostData();
                    } else {
                        console.log("No user signed in. Attempting to sign in...");
                        // Use a custom token if available, otherwise sign in anonymously
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                showModal("Connection Error", `Failed to connect to Firebase: ${error.message}`);
                console.error("Firebase initialization failed:", error);
            }
        }
        
        // --- WebRTC Logic (Host) ---
        // Placeholder for future host functionality.
        // This button won't do anything yet as this file is for the viewer.
        document.getElementById('become-host').addEventListener('click', () => {
             showModal("Feature Not Available", "This version of the app is a viewer. Please use the host's app to start a session.");
        });

        // --- Listen for Host Data in Firestore ---
        function listenForHostData() {
            const hostDocRef = doc(db, hostDocPath);

            onSnapshot(hostDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const hostData = docSnapshot.data();
                    console.log("Host data received:", hostData);
                    
                    // Check for a stream in the host data
                    if (hostData.streamId && hostData.hostId) {
                        loadingMessageEl.classList.add('hidden');
                        remoteVideoEl.src = `https://stream.example.com/${hostData.streamId}`; // This is a placeholder
                        remoteVideoEl.play().catch(e => console.error("Video playback failed:", e));
                        showModal("Watch Party Active", `A watch party is already active, hosted by ${hostData.hostId}.`);
                    } else {
                        // The host document exists but doesn't have a stream yet
                        loadingMessageEl.classList.remove('hidden');
                        remoteVideoEl.pause();
                        remoteVideoEl.src = '';
                        console.log("Host session active, but no stream found.");
                    }
                } else {
                    console.log("No active host session found.");
                    loadingMessageEl.classList.remove('hidden');
                    remoteVideoEl.pause();
                    remoteVideoEl.src = '';
                    showModal("No Host Found", "No active host session found. Please wait for a host to start sharing their screen.");
                }
            }, (error) => {
                showModal("Data Error", `Failed to listen for host data: ${error.message}`);
                console.error("Error fetching host document:", error);
            });
        }

        // Initialize the app on window load
        window.onload = initializeFirebase;

    </script>
</body>
</html>
