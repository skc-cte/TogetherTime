<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TogetherTime</title>
  <style>
    body {
      margin: 0;
      background-color: #000;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #player {
      width: 80%;
      height: 60%;
      display: none;
    }
    #controls {
      margin-top: 20px;
      display: none;
    }
    button {
      background-color: #22c55e;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin: 0 5px;
    }
    #share-link {
      margin-top: 10px;
      display: none;
    }
    #error-box {
      background: #1e1e2f;
      padding: 20px;
      border-radius: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="error-box">
    <p><b>Configuration Error</b></p>
    <p>Firebase configuration is not available. Please ensure the app is properly configured.</p>
    <button onclick="location.reload()">OK</button>
  </div>

  <div id="main-content">
    <div id="player"></div>
    <div id="controls">
      <button id="playBtn">Play</button>
      <button id="pauseBtn">Pause</button>
    </div>
    <div id="share-link">
      Share this link with friends: 
      <input type="text" id="inviteLink" readonly style="width:60%">
    </div>
  </div>

  <!-- Firebase + YouTube -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, doc, collection, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // âœ… Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCKPARNHk-6Jyl_tJpDrX_taqyktqeSA9s",
      authDomain: "my-watch-party-app.firebaseapp.com",
      projectId: "my-watch-party-app",
      storageBucket: "my-watch-party-app.firebasestorage.app",
      messagingSenderId: "72645236319",
      appId: "1:72645236319:web:98959a0f51575902726dea",
      measurementId: "G-VLQM5PG4WG"
    };

    let app, db;
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
    } catch (e) {
      document.getElementById("main-content").style.display = "none";
      document.getElementById("error-box").style.display = "block";
    }

    // Room / Host logic
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get("roomId");

    let isHost = false;
    let roomRef;

    if (roomId) {
      // Guest flow
      isHost = false;
      roomRef = doc(db, "rooms", roomId);
      console.log("Joining room as guest:", roomId);
    } else {
      // Host flow
      isHost = true;
      roomRef = doc(collection(db, "rooms"));
      console.log("Creating room as host:", roomRef.id);

      // Update URL so host can share
      window.history.replaceState(null, "TogetherTime", `?roomId=${roomRef.id}`);
      document.getElementById("share-link").style.display = "block";
      document.getElementById("inviteLink").value = window.location.href;
    }

    // YouTube player
    let player;
    window.onYouTubeIframeAPIReady = () => {
      player = new YT.Player("player", {
        height: "390",
        width: "640",
        videoId: "dQw4w9WgXcQ", // default video (replace later)
        events: {
          onReady: onPlayerReady,
        },
      });
    };

    function onPlayerReady() {
      document.getElementById("player").style.display = "block";
      if (isHost) {
        document.getElementById("controls").style.display = "block";
      }
    }

    // Host controls
    const playBtn = document.getElementById("playBtn");
    const pauseBtn = document.getElementById("pauseBtn");

    if (playBtn && pauseBtn) {
      playBtn.addEventListener("click", async () => {
        player.playVideo();
        await updateDoc(roomRef, { action: "play", time: player.getCurrentTime() });
      });

      pauseBtn.addEventListener("click", async () => {
        player.pauseVideo();
        await updateDoc(roomRef, { action: "pause", time: player.getCurrentTime() });
      });
    }

    // Sync guests with host
    if (roomRef) {
      onSnapshot(roomRef, (docSnap) => {
        if (docSnap.exists() && !isHost) {
          const data = docSnap.data();
          if (data.action === "play") {
            player.seekTo(data.time, true);
            player.playVideo();
          } else if (data.action === "pause") {
            player.seekTo(data.time, true);
            player.pauseVideo();
          }
        }
      });
    }

    // Initialize room for host
    if (isHost && roomRef) {
      setDoc(roomRef, { action: "pause", time: 0 });
    }
  </script>
</body>
</html>
